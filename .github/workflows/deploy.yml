name: Deploy Apps Script Library

on:
  push:
    branches: [ "main" ]
  create:
    tags: [ "v*" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm ci

      - name: Install clasp
        run: npm i -g @google/clasp

      # Create the service account key file securely at runtime
      - name: Write service account creds
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          python3 - <<'PY'
          import os, sys
          val = os.environ.get('GCP_SA_KEY', '').strip()
          if not val:
            print("âŒ Secret GCP_SA_KEY is empty."); sys.exit(1)
          # Write raw JSON (not base64) into sa.json
          open('sa.json','w',encoding='utf-8').write(val)
          print("âœ… sa.json created.")
          PY

      - name: Auth with Service Account (clasp)
        run: clasp login --creds sa.json

      # Ensure .clasp.json points to your library Script ID (from repo secret)
      - name: Write .clasp.json
        env:
          SCRIPT_ID_LIB: ${{ secrets.SCRIPT_ID_LIB }}
        run: |
          if [ -z "$SCRIPT_ID_LIB" ]; then
            echo "âŒ Secret SCRIPT_ID_LIB is empty."; exit 1;
          fi
          cat > .clasp.json <<EOF
          { "scriptId": "${SCRIPT_ID_LIB}", "rootDir": "dist" }
          EOF
          echo "âœ… .clasp.json written."

      - name: Push code to Apps Script
        run: clasp push -f --rootDir dist

      - name: Make Version on Tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          v="${GITHUB_REF_NAME}"
          echo "Creating version for tag ${v}"
          clasp version "Release ${v}"

      # Always remove credentials & logout, even if a step fails
      - name: Cleanup credentials
        if: always()
        run: |
          rm -f sa.json || true
          clasp logout --force || true
          echo "ðŸ§¹ Cleaned up temporary credentials."
