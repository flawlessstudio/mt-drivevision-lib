name: Deploy Apps Script Library

on:
  push:
    branches: [ "main" ]
  create:
    tags: [ "v*" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Install project deps (includes TypeScript + @types)
      - name: Install deps
        run: npm ci || npm install

      # Clasp (global) + auth lib (local for node -e)
      - name: Install Clasp + auth lib
        run: npm i -g @google/clasp && npm i google-auth-library

      # Build TypeScript -> dist/
      - name: Build TypeScript
        run: npx tsc

      # Ensure dist manifest exists before deploying
      - name: Verify dist
        run: |
          test -f dist/appsscript.json || (echo "‚ùå dist/appsscript.json missing" && exit 1)
          echo "‚úÖ dist ready"
          ls -la dist

      # Create the service account key file securely at runtime
      - name: Write service account creds
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          test -n "$GCP_SA_KEY" || (echo "‚ùå GCP_SA_KEY is empty"; exit 1)
          # Write raw JSON (multiline-safe) into sa.json
          python3 - <<'PY'
          import os, sys, json
          val = os.environ.get('GCP_SA_KEY','').strip()
          if not val:
              print("‚ùå Secret GCP_SA_KEY is empty."); sys.exit(1)
          try:
              data = json.loads(val)
          except Exception as e:
              print("‚ùå Invalid JSON in GCP_SA_KEY:", e); sys.exit(1)
          open('sa.json','w',encoding='utf-8').write(json.dumps(data))
          print("‚úÖ sa.json created")
          PY
          test -s sa.json || (echo "‚ùå sa.json is empty" && exit 1)

      # .clasp.json bound to your Apps Script Library (rootDir=dist)
      - name: Write .clasp.json
        env:
          SCRIPT_ID_LIB: ${{ secrets.SCRIPT_ID_LIB }}
        run: |
          test -n "$SCRIPT_ID_LIB" || (echo "‚ùå SCRIPT_ID_LIB is empty"; exit 1)
          cat > .clasp.json <<EOF
          { "scriptId": "${SCRIPT_ID_LIB}", "rootDir": "dist" }
          EOF
          echo "‚úÖ .clasp.json written"

      # Mint an access token from the Service Account and store it as a Clasp token
      - name: Create Clasp token from SA
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const os = require('os');
          const {GoogleAuth} = require('google-auth-library');

          const creds = JSON.parse(fs.readFileSync('sa.json','utf8'));
          const scopes = [
            'https://www.googleapis.com/auth/script.projects',
            'https://www.googleapis.com/auth/drive'
          ];

          (async () => {
            const auth = new GoogleAuth({credentials: creds, scopes});
            const client = await auth.getClient();
            const token = await client.getAccessToken();
            const access = (token && (token.token || token)) || '';
            if (!access) { console.error('‚ùå Failed to get access token'); process.exit(1); }

            const clasprc = {
              token: {
                access_token: access,
                scope: scopes.join(' '),
                token_type: 'Bearer',
                expiry_date: Date.now() + 45 * 60 * 1000
              },
              oauth2ClientSettings: {
                clientId: '',
                clientSecret: '',
                redirectUri: 'urn:ietf:wg:oauth:2.0:oob'
              },
              isLocalCreds: false
            };

            const path = `${os.homedir()}/.clasprc.json`;
            fs.writeFileSync(path, JSON.stringify(clasprc));
            console.log('‚úÖ Wrote', path);
          })().catch(e => { console.error(e); process.exit(1); });
          NODE

      # Push code in dist/ to the Apps Script Library
      - name: Push code to Apps Script
        run: clasp push -f --rootDir dist

      # Optional: create Apps Script version when pushing a git tag v*
      - name: Make Version on Tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          v="${GITHUB_REF_NAME}"
          echo "Creating version for tag ${v}"
          clasp version "Release ${v}"

      # Always clean up secrets from the runner
      - name: Cleanup credentials
        if: always()
        run: |
          rm -f sa.json || true
          rm -f ~/.clasprc.json || true
          echo "üßπ Cleaned up credentials"
