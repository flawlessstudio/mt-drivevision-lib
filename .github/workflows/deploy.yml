name: Deploy Apps Script Library
on:
  push:
    branches: [ "main" ]
  create:
    tags: [ "v*" ]
  workflow_dispatch:
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install deps
        run: npm ci
      - name: Install clasp
        run: npm i -g @google/clasp
      - name: Auth with Service Account
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          echo "$GCP_SA_KEY" > sa.json
          clasp login --creds sa.json
      - name: Write .clasp.json
        env:
          SCRIPT_ID_LIB: ${{ secrets.SCRIPT_ID_LIB }}
        run: |
          cat > .clasp.json <<EOF
          { "scriptId": "${SCRIPT_ID_LIB}", "rootDir": "dist" }
          EOF
      - name: Build & Push
        run: npm run deploy:head
      - name: Make Version on Tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: npm run version:make

