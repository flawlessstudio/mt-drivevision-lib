name: Deploy Apps Script Library
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 1Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: |
          npm ci || npm install
          npm i -g @google/clasp@2
          npm i googleapis

      # 2Ô∏è‚É£ Write the service account key securely
      - name: Write service account creds
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          echo "üß© Writing service account key..."
          python3 - <<'PY'
          import os, json, sys
          val = os.environ.get('GCP_SA_KEY', '').strip()
          if not val:
              print("‚ùå Secret GCP_SA_KEY is empty."); sys.exit(1)
          try:
              data = json.loads(val)
          except Exception as e:
              print("‚ùå Invalid JSON in GCP_SA_KEY:", e); sys.exit(1)
          open('sa.json', 'w', encoding='utf-8').write(json.dumps(data))
          print("‚úÖ sa.json created successfully.")
          PY
          test -s sa.json || (echo "‚ùå sa.json is empty" && exit 1)
          echo "sa.json size: $(wc -c < sa.json) bytes"

      # 3Ô∏è‚É£ Validate service account permissions (JWT test)
      - name: Validate Service Account Auth
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const {google} = require('googleapis');
          const key = JSON.parse(fs.readFileSync('sa.json','utf8'));
          const jwt = new google.auth.JWT(
            key.client_email, null, key.private_key,
            [
              'https://www.googleapis.com/auth/script.projects',
              'https://www.googleapis.com/auth/drive',
              'https://www.googleapis.com/auth/spreadsheets'
            ]
          );
          jwt.authorize((err, token) => {
            if (err) {
              console.error("‚ùå JWT auth failed:", err.message);
              process.exit(1);
            } else {
              console.log("‚úÖ JWT authorized. Access token generated.");
              fs.writeFileSync('token.json', JSON.stringify(token));
            }
          });
          NODE

      # 4Ô∏è‚É£ Write clasp configuration dynamically
      - name: Write .clasp.json
        env:
          SCRIPT_ID_LIB: ${{ secrets.SCRIPT_ID_LIB }}
        run: |
          echo "üß† Writing .clasp.json..."
          cat > .clasp.json <<EOF
          { "scriptId": "${SCRIPT_ID_LIB}", "rootDir": "dist" }
          EOF
          cat .clasp.json

      # 5Ô∏è‚É£ Verify dist folder before deployment
      - name: Verify dist folder
        run: |
          test -f dist/appsscript.json || (echo "‚ùå dist/appsscript.json missing" && exit 1)
          echo "‚úÖ dist manifest OK"
          ls -la dist

      # 6Ô∏è‚É£ Authenticate and deploy with clasp
      - name: Deploy to Apps Script
        run: |
          npx clasp login --creds sa.json
          echo "üöÄ Pushing latest code..."
          npx clasp push -f || (echo "‚ùå clasp push failed" && exit 1)
          echo "‚úÖ Code pushed successfully!"

      # 7Ô∏è‚É£ Optional: create version/tag
      - name: Create new version
        if: github.ref == 'refs/heads/main'
        run: |
          echo "üè∑ Creating new version..."
          npx clasp version "Auto-deployed by GitHub Actions"
          echo "‚úÖ Version created."

      # 8Ô∏è‚É£ Confirm completion
      - name: Done
        run: echo "üéâ Deployment finished successfully!"
